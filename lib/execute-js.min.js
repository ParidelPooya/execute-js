!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("execute-js",[],e):"object"==typeof exports?exports["execute-js"]=e():t["execute-js"]=e()}("undefined"!=typeof self?self:this,function(){return function(t){function e(i){if(n[i])return n[i].exports;var r=n[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,e),r.l=!0,r.exports}var n={};return e.m=t,e.c=n,e.d=function(t,n,i){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:i})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=0)}([function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t},c=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),s=n(1),a=function(){function t(e){i(this,t);var r={logger:console,context:{},cache:n(2)};void 0===t._actions&&(t._actions={}),t._actions[t.builtinActionType.DEFAULT]=t.defaultAction,t._actions[t.builtinActionType.PROMISE]=t.promiseAction,t._actions[t.builtinActionType.MAP]=t.mapActionHandler,t._actions[t.builtinActionType.CHILD_EXECUTION_TREE]=t.childExecutionTreeHandler,this._options=s.spreadify()(r,e||{})}return c(t,[{key:"run",value:function(t,e){return this.executeExecutionTree(t,e).then(function(t){return t.result})}},{key:"nextStepKey",value:function(t,e){return"function"==typeof t.test?t.test(e,this._options):t.test}},{key:"nextStep",value:function(e,n){var i=this.nextStepKey(e,n);return this._options.logger.info(o({step:e.title,event:t.eventsTitle.testResult,testResult:i},this._options.context)),void 0!==e.if[i]?e.if[i]:e.if.default}},{key:"goToNextStep",value:function(t,e){var n=this.nextStep(t,e);return void 0===n?Promise.reject("Unhandled scenario"):"number"==typeof n?Promise.resolve({result:{},signal:n}):this.executeExecutionTree(n,e)}},{key:"executeStepActionWithRetry",value:function(e,n){var i=this;return function r(c){return t._actions[e.actionType].apply(i,[e.action,n,i._options]).catch(function(n){return e.statistics.errors++,--c>0&&e.errorHandling.tryCondition(n)?(i._options.logger.warn(o({step:e.title,event:t.eventsTitle.actionRetry,cause:n},i._options.context)),r(c)):(i._options.logger.error(o({step:e.title,event:t.eventsTitle.actionFailed,cause:n},i._options.context)),Promise.reject(n))})}(e.errorHandling.maxAttempts)}},{key:"executeStepActionWithCircuitBreaker",value:function(t,e){if(!t.circuitBreaker.enable)return this.executeStepActionWithRetry(t,e);var n=t.circuitBreaker;return n.shortCircuited&&new Date-n.shortCircuitStartTime>n.duration&&(n.shortCircuited=!1,n.failed=0,n.successful=0),n.shortCircuited?Promise.reject("Short Circuited"):this.executeStepActionWithRetry(t,e).then(function(t){return n.successful++,t}).catch(function(t){n.failed++;var e=n.successful+n.failed;return e>n.waitThreshold&&n.failed/e>n.threshold&&(n.shortCircuited=!0,n.shortCircuitStartTime=new Date,n.shortCircuitCount++),Promise.reject(t)})}},{key:"executeStepActionWithCache",value:function(e,n){var i=this;if(e.cache.enable){var r=e.cache.key(n);if(void 0!==r&&""!==r){var c=new Date;return this._options.cache.get(r).then(function(s){return void 0!==s&&null!==s?(i._options.logger.info(o({step:e.title,event:t.eventsTitle.cacheHit,result:s},i._options.context)),e.statistics.cache.hitsNo++,e.statistics.cache.hitsTotal+=new Date-c,s):(i._options.logger.info(o({step:e.title,event:t.eventsTitle.cacheMiss},i._options.context)),e.statistics.cache.missesNo++,c=new Date,i.executeStepActionWithCircuitBreaker(e,n).then(function(n){return i._options.cache.set(r,n,e.cache.ttl).then(function(r){return i._options.logger.info(o({step:e.title,event:t.eventsTitle.cacheSet,setResult:r},i._options.context)),e.statistics.cache.missesTotal+=new Date-c,n})}))})}}return this.executeStepActionWithCircuitBreaker(e,n)}},{key:"executeStepActionAndHandleError",value:function(e,n){var i=this;return this.executeStepActionWithCache(e,n).catch(function(r){var c=void 0;return c="function"==typeof e.errorHandling.onError?Promise.resolve(e.errorHandling.onError(r,n,i._options)):i.executeExecutionTree(e.errorHandling.onError,o({},n,{error:r})).then(function(t){return t.result}),c.then(function(n){return e.errorHandling.continueOnError?(i._options.logger.warn(o({step:e.title,event:t.eventsTitle.continueOnError},i._options.context)),{result:n,signal:t.executionMode.CONTINUE}):(i._options.logger.error(o({step:e.title,event:t.eventsTitle.actionFailed,cause:r},i._options.context)),Promise.reject(r))})})}},{key:"processStep",value:function(e,n){var i=this;return this._options.logger.info(o({step:e.title,event:t.eventsTitle.stepStartProcessing},this._options.context)),"test"in e?this.goToNextStep(e,n).then(function(n){return i._options.logger.info(o({step:e.title,event:t.eventsTitle.childFinished},i._options.context)),n.result=s.getByPath(n.result,e.output.map.source),n}):this.executeStepActionAndHandleError(e,n).then(function(n){return n.result=s.getByPath(n.result,e.output.map.source),i._options.logger.info(o({step:e.title,event:t.eventsTitle.stepFinished,result:n.result},i._options.context)),n})}},{key:"recordStatistics",value:function(t,e){t.statistics.count++,t.statistics.min=Math.min(e,t.statistics.min),t.statistics.max=Math.max(e,t.statistics.max),t.statistics.total+=e}},{key:"executeExecutionTreeSteps",value:function(e,n){var i=this,r={},o=t.executionMode.CONTINUE,c=0,a=[],u=[];e.steps.map(function(t){u.push(function(){var e=new Date;return i.processStep(t,n).then(function(c){var a=new Date-e;return i.recordStatistics(t,a),o=Math.max(o,c.signal),t.output.accessibleToNextSteps&&(0!==t.output.map.destination.length?s.copyData(n,c.result,t.output.map.destination):n=s.extend(n,c.result)),t.output.addToResult&&(0!==t.output.map.destination.length?s.copyData(r,c.result,t.output.map.destination):r=s.extend(r,c.result)),{result:r,signal:o}})})});for(;c<e.concurrency&&c<u.length;)a.push(function e(){if(c<u.length&&o===t.executionMode.CONTINUE)return u[c++]().then(e)}());return Promise.all(a).then(function(){return{result:r,signal:o===t.executionMode.STOP_ENTIRE_EXECUTION?o:t.executionMode.CONTINUE}})}},{key:"executeExecutionTreeWithRetry",value:function(e,n){var i=this;return function r(c){return i.executeExecutionTreeSteps(e,n).catch(function(n){return e.statistics.errors++,--c>0&&e.errorHandling.tryCondition(n)?(i._options.logger.warn(o({step:e.title,event:t.eventsTitle.executionTreeActionRetry,cause:n},i._options.context)),r(c)):(i._options.logger.error(o({step:e.title,event:t.eventsTitle.executionTreeActionFailed,cause:n},i._options.context)),Promise.reject(n))})}(e.errorHandling.maxAttempts)}},{key:"executeExecutionTreeWithCache",value:function(e,n){var i=this;if(e.cache.enable){var r=e.cache.key(n);if(void 0!==r&&""!==r){var c=new Date;return this._options.cache.get(r).then(function(s){return void 0!==s&&null!==s?(i._options.logger.info(o({step:e.title,event:t.eventsTitle.executionTreeCacheHit,result:s},i._options.context)),e.statistics.cache.hitsNo++,e.statistics.cache.hitsTotal+=new Date-c,s):(i._options.logger.info(o({step:e.title,event:t.eventsTitle.executionTreeCacheMiss},i._options.context)),e.statistics.cache.missesNo++,c=new Date,i.executeExecutionTreeWithRetry(e,n).then(function(n){return i._options.cache.set(r,n,e.cache.ttl).then(function(r){return i._options.logger.info(o({step:e.title,event:t.eventsTitle.executionTreeCacheSet,setResult:r},i._options.context)),e.statistics.cache.missesTotal+=new Date-c,n})}))})}}return this.executeExecutionTreeWithRetry(e,n)}},{key:"executeExecutionTree",value:function(e,n){var i=this,r=new Date;return this.executeExecutionTreeWithCache(e,n).then(function(t){var n=new Date-r;return i.recordStatistics(e,n),t}).catch(function(r){var c=void 0;return c="function"==typeof e.errorHandling.onError?Promise.resolve(e.errorHandling.onError(r,n,i._options)):i.executeExecutionTree(e.errorHandling.onError,o({},n,{error:r})).then(function(t){return t.result}),c.then(function(n){return e.errorHandling.continueOnError?(i._options.logger.warn(o({step:e.title,event:t.eventsTitle.executionTreeContinueOnError},i._options.context)),{result:n,signal:t.executionMode.CONTINUE}):Promise.reject(r)})})}}],[{key:"defaultAction",value:function(e,n,i){return Promise.resolve(e(n,i)).then(function(e){return{result:e,signal:t.executionMode.CONTINUE}})}},{key:"promiseAction",value:function(e,n,i){return e(n,i).then(function(e){return{result:e,signal:t.executionMode.CONTINUE}})}},{key:"childExecutionTreeHandler",value:function(t,e){var n=t.executionData?t.executionData(e):e;return this.executeExecutionTree(t.executionTree,n)}},{key:"mapActionHandler",value:function(e,n,i){var r=this,o=[],c=void 0;return c=void 0!==e.reducer?e.array(n).reduce(function(t,n){return t.then(function(){return Promise.resolve(e.reducer(n,i)).then(function(t){return o.push(t),o})}).catch(console.error)},Promise.resolve()):e.array(n).reduce(function(t,i){return t.then(function(){var t=e.executionData?e.executionData(n,i):i;return r.executeExecutionTree(e.executionTree,t).then(function(t){return o.push(t.result),o})})},Promise.resolve()),c.then(function(e){return{result:e,signal:t.executionMode.CONTINUE}})}},{key:"prepareExecutionTree",value:function(e){var n=void 0;return n="[object Array]"===Object.prototype.toString.call(e)?{steps:e}:e,n=s.spreadify(!0)(s.clone(t.executionTreeDefaultSetting),n),"function"!=typeof n.errorHandling.onError&&(n.errorHandling.onError=t.prepareExecutionTree(n.errorHandling.onError)),n.steps.forEach(function(e,i){n.steps[i]=t.prepareExecutionTreeStep(e)}),n}},{key:"prepareExecutionTreeStep",value:function(e){var n=s.spreadify(!0)(s.clone(t.stepDefaultSetting),e);return"function"!=typeof n.errorHandling.onError&&(n.errorHandling.onError=t.prepareExecutionTree(n.errorHandling.onError)),void 0!==n.if&&Object.keys(n.if).forEach(function(e){"object"===r(n.if[e])&&(n.if[e]=t.prepareExecutionTree(n.if[e]))}),n.actionType===t.builtinActionType.CHILD_EXECUTION_TREE?n.action.executionTree=t.prepareExecutionTree(n.action.executionTree):n.actionType===t.builtinActionType.MAP&&n.action.executionTree&&(n.action.executionTree=t.prepareExecutionTree(n.action.executionTree)),n}},{key:"extractStatistics",value:function(e){var n={title:e.title,steps:[]};return n.statistics=e.statistics,0!==n.statistics.count&&(n.statistics.avg=n.statistics.total/n.statistics.count),0!==n.statistics.cache.missesNo&&(n.statistics.cache.missesAvg=n.statistics.cache.missesTotal/n.statistics.cache.missesNo),0!==n.statistics.cache.hitsNo&&(n.statistics.cache.hitsAvg=n.statistics.cache.hitsTotal/n.statistics.cache.hitsNo),e.steps.forEach(function(e,i){n.steps.push({});var o=n.steps[i];o.title=e.title,o.statistics=e.statistics,0!==o.statistics.count&&(o.statistics.avg=o.statistics.total/o.statistics.count),0!==o.statistics.cache.missesNo&&(o.statistics.cache.missesAvg=o.statistics.cache.missesTotal/o.statistics.cache.missesNo),0!==o.statistics.cache.hitsNo&&(o.statistics.cache.hitsAvg=o.statistics.cache.hitsTotal/o.statistics.cache.hitsNo),void 0!==e.if&&(o.if={},Object.keys(e.if).forEach(function(n){"object"===r(e.if[n])&&(o.if[n]=t.extractStatistics(e.if[n]))}))}),s.clone(n)}},{key:"getStepById",value:function(e,n){for(var i=0;i<e.steps.length;i++){var r=e.steps[i];if(r.id===n)return r;if(void 0!==r.if)for(var o=Object.keys(r.if),c=0;c<o.length;c++){var s=r.if[o[c]];if("number"!=typeof s){var a=t.getStepById(s,n);if(!1!==a)return a}}}return!1}},{key:"use",value:function(e){if(!e.type)throw new Error("type is missing in middleware contract");switch(e.type){case"action":return t.addActionMiddleware(e);default:throw new Error("Unknown middleware type")}}},{key:"addActionMiddleware",value:function(e){if(!e.action)throw new Error("Middleware action is missing");if(!e.name)throw new Error("Middleware name is missing");return void 0===t._actions&&(t._actions={}),t._actions[e.name]=e.action,!0}}]),t}();a.eventsTitle={testResult:"Test Result",actionRetry:"Retry Step's Action",actionFailed:"Step's Action Failed",continueOnError:"Step's Action Failed, Continue Executing",executionTreeActionRetry:"Retry Executing Execution Tree",executionTreeActionFailed:"Executing Execution Tree Failed",executionTreeContinueOnError:"Executing Execution Tree Failed, Continue Executing",cacheHit:"Step's Cache Hit, Data Exist in Cache",cacheMiss:"Step's Cache Miss, Data doesn't Exist in Cache",cacheSet:"Step's Cache Set, Data Inserted to Cache",executionTreeCacheHit:"Execution Tree's Cache Hit, Data Exist in Cache",executionTreeCacheMiss:"Execution Tree's Cache Miss, Data doesn't Exist in Cache",executionTreeCacheSet:"Execution Tree's Cache Set, Data Inserted to Cache",stepStartProcessing:"Start Processing Step",childFinished:"Child Execution Tree Returned Data",stepFinished:"Step Execution Finished"},a.executionMode={CONTINUE:0,STOP_LEVEL_EXECUTION:1,STOP_ENTIRE_EXECUTION:2},a.builtinActionType={DEFAULT:"default",PROMISE:"promise",MAP:"map",CHILD_EXECUTION_TREE:"execution-tree"},a.executionTreeDefaultSetting={title:"No name execution tree",concurrency:1,cache:{enable:!1,ttl:60},errorHandling:{maxAttempts:0,tryCondition:function(){return!0},continueOnError:!1,onError:function(){return{}}},statistics:{count:0,total:0,min:Number.MAX_VALUE,max:0,errors:0,cache:{missesNo:0,missesTotal:0,hitsNo:0,hitsTotal:0}}},a.stepDefaultSetting={title:"No name step",errorHandling:{maxAttempts:0,tryCondition:function(){return!0},continueOnError:!1,onError:function(){return{}}},circuitBreaker:{enable:!1,duration:1e4,threshold:.4,waitThreshold:50,shortCircuitStartTime:0,shortCircuited:!1,shortCircuitCount:0,failed:0,successful:0},cache:{enable:!1,ttl:60},output:{accessibleToNextSteps:!0,addToResult:!0,map:{source:"",destination:""}},actionType:"default",action:function(){return{}},statistics:{count:0,total:0,min:Number.MAX_VALUE,max:0,errors:0,cache:{missesNo:0,missesTotal:0,hitsNo:0,hitsTotal:0}}},t.exports=a},function(t,e,n){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r=function(t,e){if(0===e.length)return t;for(var n=e.split("."),i=0;i<n.length;i++)if(void 0===(t=t[n[i]]))return;return t},o=function(t,e,n){for(var i=t,r=n.split("."),o=0;o<r.length;o++)o===r.length-1?i[r[o]]=e:(void 0===i[r[o]]&&(i[r[o]]={}),i=i[r[o]])},c=function t(e){return function(){for(var n=arguments,r={},o=0;o<arguments.length;o++)!function(o){var c=n[o];Object.keys(c).map(function(n){e&&"object"===i(r[n])&&null!==c[n]?r[n]=t(e)(r[n],c[n]):r[n]=c[n]})}(o);return r}},s=function(t,e){return"string"==typeof e?e:Array.isArray(e)?Array.isArray(t)?t.concat(e):e:(Object.keys(e).map(function(n){t[n]=e[n]}),t)},a=function t(e){var n=void 0;if("object"!==(void 0===e?"undefined":i(e))||null===e)return e;if(e instanceof Array){n=[];for(var r=0,o=e.length;r<o;r++)n[r]=t(e[r]);return n}n={};for(var c in e)n[c]=t(e[c]);return n};t.exports={getByPath:r,copyData:o,spreadify:c,extend:s,clone:a}},function(t,e,n){"use strict";(function(e){var n=Symbol.for("TinyCache.data");Object.getOwnPropertySymbols(e).indexOf(n)>-1||(e[n]={});var i={get:function(t){return new Promise(function(i){i(e[n][t])})},set:function(t,i){return new Promise(function(r){e[n][t]=i,r(!0)})}};Object.freeze(i),t.exports=i}).call(e,n(3))},function(t,e){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(n=window)}t.exports=n}])});