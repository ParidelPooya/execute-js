!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("execute-js",[],e):"object"==typeof exports?exports["execute-js"]=e():t["execute-js"]=e()}("undefined"!=typeof self?self:this,function(){return function(t){function e(i){if(n[i])return n[i].exports;var o=n[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var n={};return e.m=t,e.c=n,e.d=function(t,n,i){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:i})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=0)}([function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t},s=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),c=n(1),a=function(){function t(e){i(this,t);var o={logger:console,context:{},cache:n(2)};void 0===t._actions&&(t._actions={}),t._actions[t.builtinActionType.DEFAULT]=t.defaultAction,t._actions[t.builtinActionType.PROMISE]=t.promiseAction,t._actions[t.builtinActionType.MAP]=t.mapActionHandler,t._actions[t.builtinActionType.CHILD_EXECUTION_TREE]=t.childExecutionTreeHandler,this._options=c.spreadify()(o,e||{})}return s(t,[{key:"run",value:function(t,e){return this.executeExecutionTree(t,e).then(function(t){return t.result})}},{key:"goToNextStep",value:function(e,n){var i="function"==typeof e.test?e.test(n,this._options):e.test;this._options.logger.info(r({step:e.title,event:t.eventsTitle.testResult,testResult:i},this._options.context));var o=void 0!==e.if[i]?e.if[i]:e.if.default;return void 0===o?Promise.reject("Unhandled scenario"):"number"==typeof o?Promise.resolve({result:{},signal:o}):this.executeExecutionTree(o,n)}},{key:"executeStepActionWithRetry",value:function(e,n){var i=this;return function o(s){return t._actions[e.actionType].apply(i,[e.action,n,i._options]).catch(function(n){return e.statistics.errors++,--s>0&&e.errorHandling.tryCondition(n)?(i._options.logger.warn(r({step:e.title,event:t.eventsTitle.actionRetry,cause:n},i._options.context)),o(s)):(i._options.logger.error(r({step:e.title,event:t.eventsTitle.actionFailed,cause:n},i._options.context)),Promise.reject(n))})}(e.errorHandling.maxAttempts)}},{key:"executeStepActionWithCircuitBreaker",value:function(t,e){if(!t.circuitBreaker.enable)return this.executeStepActionWithRetry(t,e);var n=t.circuitBreaker;return n.shortCircuited&&new Date-n.shortCircuitStartTime>n.duration&&(n.shortCircuited=!1,n.failed=0,n.successful=0),n.shortCircuited?Promise.reject("Short Circuited"):this.executeStepActionWithRetry(t,e).then(function(t){return n.successful++,t}).catch(function(t){n.failed++;var e=n.successful+n.failed;return e>n.waitThreshold&&n.failed/e>n.threshold&&(n.shortCircuited=!0,n.shortCircuitStartTime=new Date,n.shortCircuitCount++),Promise.reject(t)})}},{key:"executeStepActionWithCache",value:function(e,n){var i=this;if(e.cache.enable){var o=e.cache.key(n);if(void 0!==o&&""!==o){var s=new Date;return this._options.cache.get(o).then(function(c){return void 0!==c&&null!==c?(i._options.logger.info(r({step:e.title,event:t.eventsTitle.cacheHit,result:c},i._options.context)),e.statistics.cache.hitsNo++,e.statistics.cache.hitsTotal+=new Date-s,c):(i._options.logger.info(r({step:e.title,event:t.eventsTitle.cacheMiss},i._options.context)),e.statistics.cache.missesNo++,s=new Date,i.executeStepActionWithCircuitBreaker(e,n).then(function(n){return i._options.cache.set(o,n,e.cache.ttl).then(function(o){return i._options.logger.info(r({step:e.title,event:t.eventsTitle.cacheSet,setResult:o},i._options.context)),e.statistics.cache.missesTotal+=new Date-s,n})}))})}}return this.executeStepActionWithCircuitBreaker(e,n)}},{key:"executeStepActionAndHandleError",value:function(e,n){var i=this;return this.executeStepActionWithCache(e,n).catch(function(o){return Promise.resolve(e.errorHandling.onError(o,n,i._options)).then(function(n){return e.errorHandling.continueOnError?(i._options.logger.warn(r({step:e.title,event:t.eventsTitle.continueOnError},i._options.context)),{result:n,signal:t.executionMode.CONTINUE}):(i._options.logger.error(r({step:e.title,event:t.eventsTitle.actionFailed,cause:o},i._options.context)),Promise.reject(o))})})}},{key:"processStep",value:function(e,n){var i=this;return this._options.logger.info(r({step:e.title,event:t.eventsTitle.stepStartProcessing},this._options.context)),"test"in e?this.goToNextStep(e,n).then(function(n){return i._options.logger.info(r({step:e.title,event:t.eventsTitle.childFinished},i._options.context)),n.result=c.getByPath(n.result,e.output.map.source),n}):this.executeStepActionAndHandleError(e,n).then(function(n){return n.result=c.getByPath(n.result,e.output.map.source),i._options.logger.info(r({step:e.title,event:t.eventsTitle.stepFinished,result:n.result},i._options.context)),n})}},{key:"recordStatistics",value:function(t,e){t.statistics.count++,t.statistics.min=Math.min(e,t.statistics.min),t.statistics.max=Math.max(e,t.statistics.max),t.statistics.total+=e}},{key:"executeExecutionTreeSteps",value:function(e,n){var i=this,o={},r=t.executionMode.CONTINUE,s=0,a=[],u=[];e.steps.map(function(t){u.push(function(){var e=new Date;return i.processStep(t,n).then(function(s){var a=new Date-e;return i.recordStatistics(t,a),r=Math.max(r,s.signal),t.output.accessibleToNextSteps&&(0!==t.output.map.destination.length?c.copyData(n,s.result,t.output.map.destination):n=c.extend(n,s.result)),t.output.addToResult&&(0!==t.output.map.destination.length?c.copyData(o,s.result,t.output.map.destination):o=c.extend(o,s.result)),{result:o,signal:r}})})});for(;s<e.concurrency&&s<u.length;)a.push(function e(){if(s<u.length&&r===t.executionMode.CONTINUE)return u[s++]().then(e)}());return Promise.all(a).then(function(){return{result:o,signal:r===t.executionMode.STOP_ENTIRE_EXECUTION?r:t.executionMode.CONTINUE}})}},{key:"executeExecutionTreeWithRetry",value:function(e,n){var i=this;return function o(s){return i.executeExecutionTreeSteps(e,n).catch(function(n){return e.statistics.errors++,--s>0&&e.errorHandling.tryCondition(n)?(i._options.logger.warn(r({step:e.title,event:t.eventsTitle.executionTreeActionRetry,cause:n},i._options.context)),o(s)):(i._options.logger.error(r({step:e.title,event:t.eventsTitle.executionTreeActionFailed,cause:n},i._options.context)),Promise.reject(n))})}(e.errorHandling.maxAttempts)}},{key:"executeExecutionTreeWithCache",value:function(e,n){var i=this;if(e.cache.enable){var o=e.cache.key(n);if(void 0!==o&&""!==o){var s=new Date;return this._options.cache.get(o).then(function(c){return void 0!==c&&null!==c?(i._options.logger.info(r({step:e.title,event:t.eventsTitle.executionTreeCacheHit,result:c},i._options.context)),e.statistics.cache.hitsNo++,e.statistics.cache.hitsTotal+=new Date-s,c):(i._options.logger.info(r({step:e.title,event:t.eventsTitle.executionTreeCacheMiss},i._options.context)),e.statistics.cache.missesNo++,s=new Date,i.executeExecutionTreeWithRetry(e,n).then(function(n){return i._options.cache.set(o,n,e.cache.ttl).then(function(o){return i._options.logger.info(r({step:e.title,event:t.eventsTitle.executionTreeCacheSet,setResult:o},i._options.context)),e.statistics.cache.missesTotal+=new Date-s,n})}))})}}return this.executeExecutionTreeWithRetry(e,n)}},{key:"executeExecutionTree",value:function(e,n){var i=this,o=new Date;return this.executeExecutionTreeWithCache(e,n).then(function(t){var n=new Date-o;return i.recordStatistics(e,n),t}).catch(function(o){return Promise.resolve(e.errorHandling.onError(o,n,i._options)).then(function(n){return e.errorHandling.continueOnError?(i._options.logger.warn(r({step:e.title,event:t.eventsTitle.executionTreeContinueOnError},i._options.context)),{result:n,signal:t.executionMode.CONTINUE}):Promise.reject(o)})})}}],[{key:"defaultAction",value:function(e,n,i){return Promise.resolve(e(n,i)).then(function(e){return{result:e,signal:t.executionMode.CONTINUE}})}},{key:"promiseAction",value:function(e,n,i){return e(n,i).then(function(e){return{result:e,signal:t.executionMode.CONTINUE}})}},{key:"childExecutionTreeHandler",value:function(t,e){var n=t.executionData?t.executionData(e):e;return this.executeExecutionTree(t.executionTree,n)}},{key:"mapActionHandler",value:function(e,n,i){var o=this,r=[],s=void 0;return s=void 0!==e.reducer?e.array(n).reduce(function(t,n){return t.then(function(){return Promise.resolve(e.reducer(n,i)).then(function(t){return r.push(t),r})}).catch(console.error)},Promise.resolve()):e.array(n).reduce(function(t,i){return t.then(function(){var t=e.executionData?e.executionData(n,i):i;return o.executeExecutionTree(e.executionTree,t).then(function(t){return r.push(t.result),r})})},Promise.resolve()),s.then(function(e){return{result:e,signal:t.executionMode.CONTINUE}})}},{key:"prepareExecutionTree",value:function(e){var n=void 0;return n="[object Array]"===Object.prototype.toString.call(e)?{steps:e}:e,n=c.spreadify(!0)(c.clone(t.executionTreeDefaultSetting),n),n.steps.forEach(function(e,i){n.steps[i]=t.prepareExecutionTreeStep(e)}),n}},{key:"prepareExecutionTreeStep",value:function(e){var n=this,i=c.spreadify(!0)(c.clone(t.stepDefaultSetting),e);return void 0!==i.if&&Object.keys(i.if).forEach(function(t){"object"===o(i.if[t])&&(i.if[t]=n.prepareExecutionTree(i.if[t]))}),i.actionType===t.builtinActionType.CHILD_EXECUTION_TREE?i.action.executionTree=this.prepareExecutionTree(i.action.executionTree):i.actionType===t.builtinActionType.MAP&&i.action.executionTree&&(i.action.executionTree=this.prepareExecutionTree(i.action.executionTree)),i}},{key:"extractStatistics",value:function(e){var n={title:e.title,steps:[]};return n.statistics=e.statistics,0!==n.statistics.count&&(n.statistics.avg=n.statistics.total/n.statistics.count),0!==n.statistics.cache.missesNo&&(n.statistics.cache.missesAvg=n.statistics.cache.missesTotal/n.statistics.cache.missesNo),0!==n.statistics.cache.hitsNo&&(n.statistics.cache.hitsAvg=n.statistics.cache.hitsTotal/n.statistics.cache.hitsNo),e.steps.forEach(function(e,i){n.steps.push({});var r=n.steps[i];r.title=e.title,r.statistics=e.statistics,0!==r.statistics.count&&(r.statistics.avg=r.statistics.total/r.statistics.count),0!==r.statistics.cache.missesNo&&(r.statistics.cache.missesAvg=r.statistics.cache.missesTotal/r.statistics.cache.missesNo),0!==r.statistics.cache.hitsNo&&(r.statistics.cache.hitsAvg=r.statistics.cache.hitsTotal/r.statistics.cache.hitsNo),void 0!==e.if&&(r.if={},Object.keys(e.if).forEach(function(n){"object"===o(e.if[n])&&(r.if[n]=t.extractStatistics(e.if[n]))}))}),c.clone(n)}},{key:"getStepById",value:function(e,n){for(var i=0;i<e.steps.length;i++){var o=e.steps[i];if(o.id===n)return o;if(void 0!==o.if)for(var r=Object.keys(o.if),s=0;s<r.length;s++){var c=o.if[r[s]],a=t.getStepById(c,n);if(!1!==a)return a}}return!1}},{key:"use",value:function(e){if(!e.type)throw new Error("type is missing in middleware contract");switch(e.type){case"action":return t.addActionMiddleware(e);default:throw new Error("Unknown middleware type")}}},{key:"addActionMiddleware",value:function(e){if(!e.action)throw new Error("Middleware action is missing");if(!e.name)throw new Error("Middleware name is missing");return void 0===t._actions&&(t._actions={}),t._actions[e.name]=e.action,!0}}]),t}();a.eventsTitle={testResult:"Test Result",actionRetry:"Retry Step's Action",actionFailed:"Step's Action Failed",continueOnError:"Step's Action Failed, Continue Executing",executionTreeActionRetry:"Retry Executing Execution Tree",executionTreeActionFailed:"Executing Execution Tree Failed",executionTreeContinueOnError:"Executing Execution Tree Failed, Continue Executing",cacheHit:"Step's Cache Hit, Data Exist in Cache",cacheMiss:"Step's Cache Miss, Data doesn't Exist in Cache",cacheSet:"Step's Cache Set, Data Inserted to Cache",executionTreeCacheHit:"Execution Tree's Cache Hit, Data Exist in Cache",executionTreeCacheMiss:"Execution Tree's Cache Miss, Data doesn't Exist in Cache",executionTreeCacheSet:"Execution Tree's Cache Set, Data Inserted to Cache",stepStartProcessing:"Start Processing Step",childFinished:"Child Execution Tree Returned Data",stepFinished:"Step Execution Finished"},a.executionMode={CONTINUE:0,STOP_LEVEL_EXECUTION:1,STOP_ENTIRE_EXECUTION:2},a.builtinActionType={DEFAULT:"default",PROMISE:"promise",MAP:"map",CHILD_EXECUTION_TREE:"execution-tree"},a.executionTreeDefaultSetting={title:"No name execution tree",concurrency:1,cache:{enable:!1,ttl:60},errorHandling:{maxAttempts:0,tryCondition:function(){return!0},continueOnError:!1,onError:function(){return{}}},statistics:{count:0,total:0,min:Number.MAX_VALUE,max:0,errors:0,cache:{missesNo:0,missesTotal:0,hitsNo:0,hitsTotal:0}}},a.stepDefaultSetting={title:"No name step",errorHandling:{maxAttempts:0,tryCondition:function(){return!0},continueOnError:!1,onError:function(){return{}}},circuitBreaker:{enable:!1,duration:1e4,threshold:.4,waitThreshold:50,shortCircuitStartTime:0,shortCircuited:!1,shortCircuitCount:0,failed:0,successful:0},cache:{enable:!1,ttl:60},output:{accessibleToNextSteps:!0,addToResult:!0,map:{source:"",destination:""}},actionType:"default",action:function(){return{}},statistics:{count:0,total:0,min:Number.MAX_VALUE,max:0,errors:0,cache:{missesNo:0,missesTotal:0,hitsNo:0,hitsTotal:0}}},t.exports=a},function(t,e,n){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=function(t,e){if(0===e.length)return t;for(var n=e.split("."),i=0;i<n.length;i++)if(void 0===(t=t[n[i]]))return;return t},r=function(t,e,n){for(var i=t,o=n.split("."),r=0;r<o.length;r++)r===o.length-1?i[o[r]]=e:(void 0===i[o[r]]&&(i[o[r]]={}),i=i[o[r]])},s=function t(e){return function(){for(var n=arguments,o={},r=0;r<arguments.length;r++)!function(r){var s=n[r];Object.keys(s).map(function(n){e&&"object"===i(o[n])&&null!==s[n]?o[n]=t(e)(o[n],s[n]):o[n]=s[n]})}(r);return o}},c=function(t,e){return"string"==typeof e?e:Array.isArray(e)?Array.isArray(t)?t.concat(e):e:(Object.keys(e).map(function(n){t[n]=e[n]}),t)},a=function t(e){var n=void 0;if("object"!==(void 0===e?"undefined":i(e))||null===e)return e;if(e instanceof Array){n=[];for(var o=0,r=e.length;o<r;o++)n[o]=t(e[o]);return n}n={};for(var s in e)n[s]=t(e[s]);return n};t.exports={getByPath:o,copyData:r,spreadify:s,extend:c,clone:a}},function(t,e,n){"use strict";(function(e){var n=Symbol.for("TinyCache.data");Object.getOwnPropertySymbols(e).indexOf(n)>-1||(e[n]={});var i={get:function(t){return new Promise(function(i){i(e[n][t])})},set:function(t,i){return new Promise(function(o){e[n][t]=i,o(!0)})}};Object.freeze(i),t.exports=i}).call(e,n(3))},function(t,e){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(n=window)}t.exports=n}])});