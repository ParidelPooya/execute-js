!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("execute-js",[],t):"object"==typeof exports?exports["execute-js"]=t():e["execute-js"]=t()}("undefined"!=typeof self?self:this,function(){return function(e){function t(i){if(n[i])return n[i].exports;var o=n[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=2)}([function(e,t,n){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(e,t){if(0===t.length)return e;for(var n=t.split("."),i=0;i<n.length;i++)if(void 0===(e=e[n[i]]))return;return e},r=function(e,t,n){for(var i=e,o=n.split("."),r=0;r<o.length;r++)r===o.length-1?i[o[r]]=t:(void 0===i[o[r]]&&(i[o[r]]={}),i=i[o[r]])},c=function e(t){return function(){for(var n=arguments,o={},r=0;r<arguments.length;r++)!function(r){var c=n[r];Object.keys(c).map(function(n){t&&"object"===i(o[n])&&null!==c[n]?o[n]=e(t)(o[n],c[n]):o[n]=c[n]})}(r);return o}},s=function(e,t){return"string"==typeof t?t:Array.isArray(t)?Array.isArray(e)?e.concat(t):t:(Object.keys(t).map(function(n){e[n]=t[n]}),e)},a=function e(t){var n=void 0;if("object"!==(void 0===t?"undefined":i(t))||null===t)return t;if(t instanceof Array){n=[];for(var o=0,r=t.length;o<r;o++)n[o]=e(t[o]);return n}n={};for(var c in t)n[c]=e(t[c]);return n};e.exports={getByPath:o,copyData:r,spreadify:c,extend:s,clone:a}},function(e,t,n){"use strict";var i={CONTINUE:0,STOP_LEVEL_EXECUTION:1,STOP_ENTIRE_EXECUTION:2},o={DEFAULT:"default",PROMISE:"promise",MAP:"map",WHILE:"while",CHILD_EXECUTION_TREE:"execution-tree",SIGNAL:"signal"},r={concurrency:1,cache:{enable:!1,ttl:60},errorHandling:{maxAttempts:0,tryCondition:function(){return!0},continueOnError:!1,onError:function(){return{}}},statistics:{count:0,total:0,min:Number.MAX_VALUE,max:0,errors:0,cache:{missesNo:0,missesTotal:0,hitsNo:0,hitsTotal:0}}},c={statistics:{count:0,total:0,min:Number.MAX_VALUE,max:0,errors:0,cache:{missesNo:0,missesTotal:0,hitsNo:0,hitsTotal:0}}},s={title:"No name step",errorHandling:{maxAttempts:0,tryCondition:function(){return!0},continueOnError:!1,onError:function(){return{}}},circuitBreaker:{enable:!1,duration:1e4,threshold:.4,waitThreshold:50,shortCircuitStartTime:0,shortCircuited:!1,shortCircuitCount:0,failed:0,successful:0},cache:{enable:!1,ttl:60},output:{waitForTheResult:!0,accessibleToNextSteps:!0,addToResult:!0,map:{source:"",destination:""}},actionType:"default",action:function(){return{}},statistics:{count:0,total:0,min:Number.MAX_VALUE,max:0,errors:0,cache:{missesNo:0,missesTotal:0,hitsNo:0,hitsTotal:0}}},a={testResult:"Test Result",actionRetry:"Retry Step's Action",actionFailed:"Step's Action Failed",continueOnError:"Step's Action Failed, Continue Executing",executionTreeActionRetry:"Retry Executing Execution Tree",executionTreeActionFailed:"Executing Execution Tree Failed",executionTreeContinueOnError:"Executing Execution Tree Failed, Continue Executing",cacheHit:"Step's Cache Hit, Data Exist in Cache",cacheMiss:"Step's Cache Miss, Data doesn't Exist in Cache",cacheSet:"Step's Cache Set, Data Inserted to Cache",middlewareCacheHit:"middleware's Cache Hit, Data Exist in Cache",middlewareCacheMiss:"middleware's Cache Miss, Data doesn't Exist in Cache",middlewareCacheSet:"middleware's Cache Set, Data Inserted to Cache",executionTreeCacheHit:"Execution Tree's Cache Hit, Data Exist in Cache",executionTreeCacheMiss:"Execution Tree's Cache Miss, Data doesn't Exist in Cache",executionTreeCacheSet:"Execution Tree's Cache Set, Data Inserted to Cache",stepStartProcessing:"Start Processing Step",childFinished:"Child Execution Tree Returned Data",stepFinished:"Step Execution Finished"},u={title:"Root Execution Tree"};e.exports={executionMode:i,builtinActionType:o,executionTreeDefaultSetting:r,middlewareDefaultSetting:c,stepDefaultSetting:s,eventsTitle:a,rootExecutionTree:u}},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},c=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=n(0),a=n(1),u=n(3),l=function(){function e(t){i(this,e);var o={logger:console,context:{},cache:n(4)};e._middleware=e._middleware||{},e._middleware[e.builtinActionType.DEFAULT]={action:u.defaultAction},e._middleware[e.builtinActionType.PROMISE]={action:u.promiseAction},e._middleware[e.builtinActionType.MAP]={action:u.mapActionHandler},e._middleware[e.builtinActionType.WHILE]={action:u.whileActionHandler},e._middleware[e.builtinActionType.CHILD_EXECUTION_TREE]={action:u.childExecutionTreeHandler},e._middleware[e.builtinActionType.SIGNAL]={action:u.signalAction},this._options=s.spreadify()(o,t||{})}return c(e,[{key:"run",value:function(e,t){return this.executeExecutionTree(e,t).then(function(e){return e.result})}},{key:"nextStepKey",value:function(e,t){return"function"==typeof e.test?e.test(t,this._options):e.test}},{key:"nextStep",value:function(t,n){var i=this.nextStepKey(t,n);return this._options.logger.info({step:t.title,event:e.eventsTitle.testResult,testResult:i,context:this._options.context}),void 0!==t.if[i]?t.if[i]:t.if.default}},{key:"goToNextStep",value:function(e,t){var n=this.nextStep(e,t);return void 0===n?Promise.reject("Unhandled scenario"):"number"==typeof n?Promise.resolve({result:{},signal:n}):this.executeExecutionTree(n,t)}},{key:"executeStepActionWithRetry",value:function(t,n){var i=this;return function o(r){return u.executeStepActionCallMiddleware.apply(i,[t,n,e]).catch(function(n){return t.statistics.errors++,--r>0&&t.errorHandling.tryCondition(n)?(i._options.logger.warn({step:t.title,event:e.eventsTitle.actionRetry,cause:n,context:i._options.context}),o(r)):(i._options.logger.error({step:t.title,event:e.eventsTitle.actionFailed,cause:n,context:i._options.context}),Promise.reject(n))})}(t.errorHandling.maxAttempts)}},{key:"executeStepActionWithCircuitBreaker",value:function(e,t){if(!e.circuitBreaker.enable)return this.executeStepActionWithRetry(e,t);var n=e.circuitBreaker;return n.shortCircuited&&new Date-n.shortCircuitStartTime>n.duration&&(n.shortCircuited=!1,n.failed=0,n.successful=0),n.shortCircuited?Promise.reject("Short Circuited"):this.executeStepActionWithRetry(e,t).then(function(e){return n.successful++,e}).catch(function(e){n.failed++;var t=n.successful+n.failed;return t>n.waitThreshold&&n.failed/t>n.threshold&&(n.shortCircuited=!0,n.shortCircuitStartTime=new Date,n.shortCircuitCount++),Promise.reject(e)})}},{key:"executeStepActionWithCache",value:function(t,n){var i=this;if(t.cache.enable){var o=t.cache.key(n);if(void 0!==o&&""!==o){var r=new Date;return this._options.cache.get(o).then(function(c){return void 0!==c&&null!==c?(i._options.logger.info({step:t.title,event:e.eventsTitle.cacheHit,result:c,context:i._options.context}),t.statistics.cache.hitsNo++,t.statistics.cache.hitsTotal+=new Date-r,c):(i._options.logger.info({step:t.title,event:e.eventsTitle.cacheMiss,context:i._options.context}),t.statistics.cache.missesNo++,r=new Date,i.executeStepActionWithCircuitBreaker(t,n).then(function(n){return t.statistics.cache.missesTotal+=new Date-r,i._options.cache.set(o,n,t.cache.ttl).then(function(n){i._options.logger.info({step:t.title,event:e.eventsTitle.cacheSet,setResult:n,context:i._options.context})}),n}))})}}return this.executeStepActionWithCircuitBreaker(t,n)}},{key:"executeStepActionAndHandleError",value:function(t,n){var i=this;return this.executeStepActionWithCache(t,n).catch(function(o){var c=void 0;return c="function"==typeof t.errorHandling.onError?Promise.resolve(t.errorHandling.onError(o,n,i._options)):i.executeExecutionTree(t.errorHandling.onError,r({},n,{error:o})).then(function(e){return e.result}),c.then(function(n){return t.errorHandling.continueOnError?(i._options.logger.warn({step:t.title,cause:o,event:e.eventsTitle.continueOnError,context:i._options.context}),{result:n,signal:e.executionMode.CONTINUE}):(i._options.logger.error({step:t.title,event:e.eventsTitle.actionFailed,cause:o,context:i._options.context}),Promise.reject(o))})})}},{key:"processStep",value:function(t,n){var i=this;return this._options.logger.info({step:t.title,event:e.eventsTitle.stepStartProcessing,context:this._options.context}),"test"in t?this.goToNextStep(t,n).then(function(n){return i._options.logger.info({step:t.title,event:e.eventsTitle.childFinished,context:i._options.context}),{result:s.getByPath(n.result,t.output.map.source),signal:n.signal}}):this.executeStepActionAndHandleError(t,n).then(function(n){return n.result=s.getByPath(n.result,t.output.map.source),i._options.logger.info({step:t.title,event:e.eventsTitle.stepFinished,result:n.result,context:i._options.context}),n})}},{key:"recordStatistics",value:function(e,t){e.statistics.count++,e.statistics.min=Math.min(t,e.statistics.min),e.statistics.max=Math.max(t,e.statistics.max),e.statistics.total+=t}},{key:"executeExecutionTreeSteps",value:function(t,n){var i=this,o={},r=e.executionMode.CONTINUE,c=0,a=[],u=[];t.steps.map(function(t){u.push(function(){var c=new Date,a=i.processStep(t,n).then(function(e){var n=new Date-c;return i.recordStatistics(t,n),e});return(t.output.waitForTheResult?a:Promise.resolve({signal:e.executionMode.CONTINUE,result:{}})).then(function(e){return r=Math.max(r,e.signal),t.output.accessibleToNextSteps&&(0!==t.output.map.destination.length?s.copyData(n,e.result,t.output.map.destination):n=s.extend(n,e.result)),t.output.addToResult&&(0!==t.output.map.destination.length?s.copyData(o,e.result,t.output.map.destination):o=s.extend(o,e.result)),{result:o,signal:r}})})});for(;c<t.concurrency&&c<u.length;)a.push(function t(){if(c<u.length&&r===e.executionMode.CONTINUE)return u[c++]().then(t)}());return Promise.all(a).then(function(){return{result:o,signal:r===e.executionMode.STOP_ENTIRE_EXECUTION?r:e.executionMode.CONTINUE}})}},{key:"executeExecutionTreeWithRetry",value:function(t,n){var i=this;return function o(r){return i.executeExecutionTreeSteps(t,n).catch(function(n){return t.statistics.errors++,--r>0&&t.errorHandling.tryCondition(n)?(i._options.logger.warn({step:t.title,event:e.eventsTitle.executionTreeActionRetry,cause:n,context:i._options.context}),o(r)):(i._options.logger.error({step:t.title,event:e.eventsTitle.executionTreeActionFailed,cause:n,context:i._options.context}),Promise.reject(n))})}(t.errorHandling.maxAttempts)}},{key:"executeExecutionTreeWithCache",value:function(t,n){var i=this;if(t.cache.enable){var o=t.cache.key(n);if(void 0!==o&&""!==o){var r=new Date;return this._options.cache.get(o).then(function(c){return void 0!==c&&null!==c?(i._options.logger.info({step:t.title,event:e.eventsTitle.executionTreeCacheHit,result:c,context:i._options.context}),t.statistics.cache.hitsNo++,t.statistics.cache.hitsTotal+=new Date-r,c):(i._options.logger.info({step:t.title,event:e.eventsTitle.executionTreeCacheMiss,context:i._options.context}),t.statistics.cache.missesNo++,r=new Date,i.executeExecutionTreeWithRetry(t,n).then(function(n){return t.statistics.cache.missesTotal+=new Date-r,i._options.cache.set(o,n,t.cache.ttl).then(function(n){i._options.logger.info({step:t.title,event:e.eventsTitle.executionTreeCacheSet,setResult:n,context:i._options.context})}),n}))})}}return this.executeExecutionTreeWithRetry(t,n)}},{key:"executeExecutionTree",value:function(t,n){var i=this,o=r({},n),c=new Date;return this.executeExecutionTreeWithCache(t,o).then(function(e){var n=new Date-c;return i.recordStatistics(t,n),e}).catch(function(n){var c=void 0;return c="function"==typeof t.errorHandling.onError?Promise.resolve(t.errorHandling.onError(n,o,i._options)):i.executeExecutionTree(t.errorHandling.onError,r({},o,{error:n})).then(function(e){return e.result}),c.then(function(o){return t.errorHandling.continueOnError?(i._options.logger.warn({step:t.title,cause:n,event:e.eventsTitle.executionTreeContinueOnError,context:i._options.context}),{result:o,signal:e.executionMode.CONTINUE}):(i._options.logger.error({step:t.title,event:e.eventsTitle.executionTreeActionFailed,cause:n,context:i._options.context}),Promise.reject(n))})})}}],[{key:"prepareExecutionTree",value:function(t,n){var i=void 0;return i=Array.isArray(t)?{steps:t}:t,i.title=i.title||n||e.rootExecutionTree.title,i=s.spreadify(!0)(s.clone(e.executionTreeDefaultSetting),i),"function"!=typeof i.errorHandling.onError&&(i.errorHandling.onError=e.prepareExecutionTree(i.errorHandling.onError,i.title+" - onError")),i.steps.forEach(function(t,n){i.steps[n]=e.prepareExecutionTreeStep(t,i.title+" - Step "+n)}),i}},{key:"prepareExecutionTreeStep",value:function(t,n){t.title=t.title||n;var i=s.spreadify(!0)(s.clone(e.stepDefaultSetting),t);return"function"!=typeof i.errorHandling.onError&&(i.errorHandling.onError=e.prepareExecutionTree(i.errorHandling.onError,t.title+" - onError")),void 0!==i.if&&Object.keys(i.if).forEach(function(t){"object"===o(i.if[t])&&(i.if[t]=e.prepareExecutionTree(i.if[t],n+" - if "+t))}),i.actionType===e.builtinActionType.CHILD_EXECUTION_TREE?i.action.executionTree=e.prepareExecutionTree(i.action.executionTree,t.title+" - child execution tree"):i.actionType===e.builtinActionType.MAP&&i.action.executionTree?i.action.executionTree=e.prepareExecutionTree(i.action.executionTree,t.title+" - map execution tree"):i.actionType===e.builtinActionType.WHILE&&i.action.executionTree&&(i.action.executionTree=e.prepareExecutionTree(i.action.executionTree,t.title+" - while execution tree")),i}},{key:"extractStatistics",value:function(t){var n={title:t.title,steps:[]};return n.statistics=t.statistics,0!==n.statistics.count&&(n.statistics.avg=n.statistics.total/n.statistics.count),0!==n.statistics.cache.missesNo&&(n.statistics.cache.missesAvg=n.statistics.cache.missesTotal/n.statistics.cache.missesNo),0!==n.statistics.cache.hitsNo&&(n.statistics.cache.hitsAvg=n.statistics.cache.hitsTotal/n.statistics.cache.hitsNo),t.steps.forEach(function(t,i){n.steps.push({});var r=n.steps[i];r.title=t.title,r.statistics=t.statistics,0!==r.statistics.count&&(r.statistics.avg=r.statistics.total/r.statistics.count),0!==r.statistics.cache.missesNo&&(r.statistics.cache.missesAvg=r.statistics.cache.missesTotal/r.statistics.cache.missesNo),0!==r.statistics.cache.hitsNo&&(r.statistics.cache.hitsAvg=r.statistics.cache.hitsTotal/r.statistics.cache.hitsNo),void 0!==t.if&&(r.if={},Object.keys(t.if).forEach(function(n){"object"===o(t.if[n])&&(r.if[n]=e.extractStatistics(t.if[n]))}))}),s.clone(n)}},{key:"getStepById",value:function(t,n,i){for(var o=0;o<t.steps.length;o++){var r=t.steps[o];if(r.id===n)return r;if(void 0!==r.if)for(var c=Object.keys(r.if),s=0;s<c.length;s++){var a=r.if[c[s]];if("number"!=typeof a){var u=e.getStepById(a,n);if(!1!==u)return u}}if(i&&(r.actionType===e.builtinActionType.CHILD_EXECUTION_TREE||r.actionType===e.builtinActionType.MAP&&r.action.executionTree||r.actionType===e.builtinActionType.WHILE&&r.action.executionTree)){var l=e.getStepById(r.action.executionTree,n,!0);if(!1!==l)return l}}return!1}},{key:"use",value:function(t){return u.use(t,e)}}]),e}();l.eventsTitle=a.eventsTitle,l.executionMode=a.executionMode,l.builtinActionType=a.builtinActionType,l.executionTreeDefaultSetting=a.executionTreeDefaultSetting,l.middlewareDefaultSetting=a.middlewareDefaultSetting,l.stepDefaultSetting=a.stepDefaultSetting,l.rootExecutionTree=a.rootExecutionTree,e.exports=l},function(e,t,n){"use strict";function i(e,t,n){return Promise.resolve(e(t,n)).then(function(e){return{result:e,signal:h.executionMode.CONTINUE}})}function o(e){return Promise.resolve({result:{},signal:e})}function r(e,t,n){return e(t,n).then(function(e){return{result:e,signal:h.executionMode.CONTINUE}})}function c(e,t){var n=e.executionData?e.executionData(t):t;return this.executeExecutionTree(e.executionTree,n).then(function(t){return e.ignoreChildSignal&&(t.signal=h.executionMode.CONTINUE),t})}function s(e,t,n){var i=this,o=e.concurrency||1,r=[],c=0,s=[],a=[];e.array(t).map(function(o,c){a.push(function(){var s=void 0;if(void 0!==e.reducer)s=Promise.resolve(e.reducer(o,n)).then(function(e){return r[c]=e,r});else{var a=e.executionData?e.executionData(t,o):o;s=i.executeExecutionTree(e.executionTree,a).then(function(e){return r[c]=e.result,r})}return s})});for(;c<o&&c<a.length;)s.push(function e(){if(c<a.length)return a[c++]().then(e)}());return Promise.all(s).then(function(){return{result:r,signal:h.executionMode.CONTINUE}})}function a(e,t,n){function i(){return e.test(t,n)?r.executeExecutionTree(e.executionTree,t).then(function(e){return o.push(e.result),i()}):{result:o,signal:h.executionMode.CONTINUE}}var o=[],r=this;return i()}function u(e,t){if(!e.type)throw new Error("type is missing in middleware contract");switch(e.type){case"action":return l(e,t);default:throw new Error("Unknown middleware type")}}function l(e,t){if(!e.action)throw new Error("Middleware action is missing");if(!e.name)throw new Error("Middleware name is missing");return e.statistics=f.clone(h.middlewareDefaultSetting.statistics),t._middleware=t._middleware||{},t._middleware[e.name]=e,!0}function p(e,t,n){var i=this,o=n._middleware[e.actionType];if(void 0===o.cache)return o.action.apply(this,[e.action,t,this._options]);var r="function"==typeof e.action?e.action(t):e.action,c=o.cache.key(r);if(void 0!==c&&""!==c){var s=new Date;return this._options.cache.get(c).then(function(n){return void 0!==n&&null!==n?(i._options.logger.info({middleware:e.actionType,event:h.eventsTitle.middlewareCacheHit,result:n,context:i._options.context}),o.statistics.cache.hitsNo++,o.statistics.cache.hitsTotal+=new Date-s,n):(i._options.logger.info({middleware:e.actionType,event:h.eventsTitle.middlewareCacheMiss,context:i._options.context}),o.statistics.cache.missesNo++,s=new Date,o.action.apply(i,[e.action,t,i._options]).then(function(t){return o.statistics.cache.missesTotal+=new Date-s,i._options.cache.set(c,t,o.cache.ttl).then(function(t){i._options.logger.info({middleware:e.actionType,event:h.eventsTitle.middlewareCacheSet,setResult:t,context:i._options.context})}),t}))})}return o.action.apply(this,[e.action,t,this._options])}var h=n(1),f=n(0);e.exports={defaultAction:i,promiseAction:r,childExecutionTreeHandler:c,mapActionHandler:s,whileActionHandler:a,signalAction:o,use:u,executeStepActionCallMiddleware:p}},function(e,t,n){"use strict";(function(t){var n=Symbol.for("TinyCache.data");Object.getOwnPropertySymbols(t).indexOf(n)>-1||(t[n]={});var i={get:function(e){return new Promise(function(i){i(t[n][e])})},set:function(e,i){return new Promise(function(o){t[n][e]=i,o(!0)})}};Object.freeze(i),e.exports=i}).call(t,n(5))},function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n}])});