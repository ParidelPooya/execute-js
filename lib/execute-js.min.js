!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("execute-js",[],e):"object"==typeof exports?exports["execute-js"]=e():t["execute-js"]=e()}(this,function(){return function(t){function e(i){if(n[i])return n[i].exports;var r=n[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,e),r.l=!0,r.exports}var n={};return e.m=t,e.c=n,e.d=function(t,n,i){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:i})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=0)}([function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),c=function(){function t(e){i(this,t);var r={logger:console,cache:n(1)};this._actions={},this._actions[t.builtinActionType.DEFAULT]=t.defaultAction.bind(this),this._actions[t.builtinActionType.MAP]=t.mapActionHandler.bind(this),this._actions[t.builtinActionType.CHILD_EXECUTION_TREE]=t.childExecutionTreeHandler.bind(this),this._options=t.spreadify()(r,e||{})}return o(t,null,[{key:"getByPath",value:function(t,e){if(0===e.length)return t;for(var n=e.split("."),i=0;i<n.length;i++)t=t[n[i]];return t}},{key:"copyData",value:function(t,e,n){for(var i=t,r=n.split("."),o=0;o<r.length;o++)o===r.length-1?i[r[o]]=e:(void 0===i[r[o]]&&(i[r[o]]={}),i=i[r[o]])}},{key:"spreadify",value:function(e){return function(){for(var n=arguments,i={},o=0;o<arguments.length;o++)!function(o){var c=n[o];Object.keys(c).map(function(n){e&&"object"===r(i[n])&&null!==c[n]?i[n]=t.spreadify(e)(i[n],c[n]):i[n]=c[n]})}(o);return i}}},{key:"extend",value:function(t,e){return Array.isArray(e)?Array.isArray(t)?t.concat(e):e:(Object.keys(e).map(function(n){t[n]=e[n]}),t)}},{key:"clone",value:function(e){var n=void 0;if("object"!==(void 0===e?"undefined":r(e))||null===e)return e;if(e instanceof Array){n=[];for(var i=0,o=e.length;i<o;i++)n[i]=t.clone(e[i]);return n}n={};for(var c in e)n[c]=t.clone(e[c]);return n}}]),o(t,[{key:"use",value:function(t){if(!t.type)throw new Error("type is missing in middleware contract");switch(t.type){case"action":return this.addActionMiddleware(t);default:throw new Error("Unknown middleware type")}}},{key:"addActionMiddleware",value:function(t){if(!t.action)throw new Error("middleware action is missing");if(!t.name)throw new Error("middleware name is missing");return this._actions[t.name]=t.action,!0}},{key:"run",value:function(t,e){return this.executeExecutionTree(t,e).then(function(t){return t.result})}},{key:"goToNextStep",value:function(t,e){var n="function"==typeof t.test?t.test(e):t.test;this._options.logger.info("Test result: "+n);var i=void 0!==t.if[n]?t.if[n]:t.if.default;return"number"==typeof i?Promise.resolve({result:{},signal:i}):i?this.executeExecutionTree(i,e):Promise.reject("Unhandled scenario")}},{key:"executeStepActionWithRetry",value:function(t,e){var n=this;return function i(r){var o=n._actions[t.actionType](t.action,e,n._options);return Promise.resolve(o).catch(function(e){return t.statistics.errors++,--r>0&&t.errorHandling.tryCondition(e)?(n._options.logger.warn("Step: "+t.title+" failed. Retrying."),i(r)):(n._options.logger.error("Step: "+t.title+" action failed."),Promise.reject(e))})}(t.errorHandling.maxAttempts)}},{key:"executeStepActionWithCache",value:function(t,e){var n=this;if(t.cache.enable){var i=t.cache.key(e),r=new Date;return this._options.cache.get(i).then(function(o){return void 0!==o?(console.log("Data exist in cache"),t.statistics.cache.hitsNo++,t.statistics.cache.hitsTotal+=new Date-r,o):(console.log("Data is not exist in cache"),t.statistics.cache.missesNo++,r=new Date,n.executeStepActionWithRetry(t,e).then(function(e){return n._options.cache.set(i,e,t.cache.ttl).then(function(n){return console.log("Set Data in Cache result:",n),t.statistics.cache.missesTotal+=new Date-r,e})}))})}return this.executeStepActionWithRetry(t,e)}},{key:"executeStepActionAndHandleError",value:function(t,e){var n=this;return this.executeStepActionWithCache(t,e).catch(function(i){return Promise.resolve(t.errorHandling.onError(i,e,n._options)).then(function(e){return t.errorHandling.continueOnError?e:Promise.reject(i)})})}},{key:"processStep",value:function(e,n){var i=this;return this._options.logger.info("Step: "+e.title),"test"in e?this.goToNextStep(e,n).then(function(n){return i._options.logger.info("Child result: "+JSON.stringify(n.result)),n.result=t.getByPath(n.result,e.output.map.source),i._options.logger.info("Total result: "+JSON.stringify(n.result)),n}):this.executeStepActionAndHandleError(e,n).then(function(n){var r=t.getByPath(n,e.output.map.source);return i._options.logger.info("Action result: "+JSON.stringify(r)),{result:r,signal:t.executionMode.CONTINUE}})}},{key:"recordStatistics",value:function(t,e){t.statistics.count++,t.statistics.min=Math.min(e,t.statistics.min),t.statistics.max=Math.max(e,t.statistics.max),t.statistics.total+=e}},{key:"executeExecutionTreeSteps",value:function(e,n){function i(){if(s<u.length&&c===t.executionMode.CONTINUE)return u[s++]().then(i)}var r=this,o={},c=t.executionMode.CONTINUE,s=0,a=[],u=[];for(e.steps.map(function(e){u.push(function(){var i=new Date;return r.processStep(e,n).then(function(s){var a=new Date-i;return r.recordStatistics(e,a),c=Math.max(c,s.signal),e.output.accessibleToNextSteps&&(0!==e.output.map.destination.length?t.copyData(n,s.result,e.output.map.destination):n=t.extend(n,s.result)),e.output.addToResult&&(0!==e.output.map.destination.length?t.copyData(o,s.result,e.output.map.destination):o=t.extend(o,s.result)),{result:o,signal:c}})})});s<e.concurrency&&s<u.length;)a.push(i());return Promise.all(a).then(function(){return{result:o,signal:c===t.executionMode.STOP_ENTIRE_EXECUTION?c:t.executionMode.CONTINUE}})}},{key:"executeExecutionTreeWithRetry",value:function(t,e){var n=this;return function i(r){return n.executeExecutionTreeSteps(t,e).catch(function(e){return t.statistics.errors++,--r>0&&t.errorHandling.tryCondition(e)?(n._options.logger.warn("Execution Tree: "+t.title+" failed. Retrying."),i(r)):(n._options.logger.error("Execution Tree: "+t.title+" failed."),Promise.reject(e))})}(t.errorHandling.maxAttempts)}},{key:"executeExecutionTreeWithCache",value:function(t,e){var n=this;if(t.cache.enable){var i=t.cache.key(e),r=new Date;return this._options.cache.get(i).then(function(o){return void 0!==o?(console.log("Data exist in cache"),t.statistics.cache.hitsNo++,t.statistics.cache.hitsTotal+=new Date-r,o):(console.log("Data is not exist in cache"),t.statistics.cache.missesNo++,r=new Date,n.executeExecutionTreeWithRetry(t,e).then(function(e){return n._options.cache.set(i,e,t.cache.ttl).then(function(n){return console.log("Set Data in Cache result:",n),t.statistics.cache.missesTotal+=new Date-r,e})}))})}return this.executeExecutionTreeWithRetry(t,e)}},{key:"executeExecutionTree",value:function(e,n){var i=this;return this.executeExecutionTreeWithCache(e,n).catch(function(r){return Promise.resolve(e.errorHandling.onError(r,n,i._options)).then(function(n){return e.errorHandling.continueOnError?{result:n,signal:t.executionMode.CONTINUE}:Promise.reject(r)})})}}],[{key:"defaultAction",value:function(t,e,n){return Promise.resolve(t(e,n))}},{key:"childExecutionTreeHandler",value:function(t,e){var n=t.executionData?t.executionData(e):e;return this.executeExecutionTree(t.executionTree,n).then(function(t){return t.result})}},{key:"mapActionHandler",value:function(t,e,n){var i=this,r=[];return void 0!==t.reducer?t.array(e).reduce(function(e,i){return e.then(function(){return Promise.resolve(t.reducer(i,n)).then(function(t){return r.push(t),r})}).catch(console.error)},Promise.resolve()):t.array(e).reduce(function(n,o){return n.then(function(){var n=t.executionData?t.executionData(e,o):o;return i.executeExecutionTree(t.executionTree,n).then(function(t){return r.push(t.result),r})}).catch(console.error)},Promise.resolve())}},{key:"prepareExecutionTree",value:function(e){var n=void 0;return n="[object Array]"===Object.prototype.toString.call(e)?{steps:e}:e,n=t.spreadify(!0)(t.executionTreeDefaultSetting,n),n.steps.forEach(function(e,i){n.steps[i]=t.prepareExecutionTreeStep(e)}),n}},{key:"prepareExecutionTreeStep",value:function(e){var n=this,i=t.spreadify(!0)(t.clone(t.stepDefaultSetting),e);return void 0!==i.if&&Object.keys(i.if).forEach(function(t){"object"===r(i.if[t])&&(i.if[t]=n.prepareExecutionTree(i.if[t]))}),i.actionType===t.builtinActionType.CHILD_EXECUTION_TREE&&(i.action.executionTree=this.prepareExecutionTree(i.action.executionTree)),i.actionType===t.builtinActionType.MAP&&void 0!==i.action.executionTree&&(i.action.executionTree=this.prepareExecutionTree(i.action.executionTree)),i}},{key:"extractStatistics",value:function(e){var n={steps:[]};return e.steps.forEach(function(e,i){n.steps.push({});var o=n.steps[i];o.title=e.title,o.statistics=e.statistics,0!==o.statistics.count&&(o.statistics.avg=o.statistics.total/o.statistics.count),0!==o.statistics.cache.missesNo&&(o.statistics.cache.missesAvg=o.statistics.cache.missesTotal/o.statistics.cache.missesNo),0!==o.statistics.cache.hitsNo&&(o.statistics.cache.hitsAvg=o.statistics.cache.hitsTotal/o.statistics.cache.hitsNo),void 0!==e.if&&(o.if={},Object.keys(e.if).forEach(function(n){"object"===r(e.if[n])&&(o.if[n]=t.extractStatistics(e.if[n]))}))}),t.clone(n)}}]),t}();c.executionMode={CONTINUE:0,STOP_LEVEL_EXECUTION:1,STOP_ENTIRE_EXECUTION:2},c.builtinActionType={DEFAULT:"default",MAP:"map",CHILD_EXECUTION_TREE:"execution-tree"},c.executionTreeDefaultSetting={title:"No name execution tree",concurrency:1,cache:{enable:!1,ttl:60},errorHandling:{maxAttempts:0,tryCondition:function(){return!0},continueOnError:!1,onError:function(){return{}}},statistics:{count:0,total:0,min:Number.MAX_VALUE,max:0,errors:0,cache:{missesNo:0,missesTotal:0,hitsNo:0,hitsTotal:0}}},c.stepDefaultSetting={title:"No name step",errorHandling:{maxAttempts:0,tryCondition:function(){return!0},continueOnError:!1,onError:function(){return{}}},cache:{enable:!1,ttl:60},output:{accessibleToNextSteps:!0,addToResult:!0,map:{source:"",destination:""}},actionType:"default",action:function(){return{}},statistics:{count:0,total:0,min:Number.MAX_VALUE,max:0,errors:0,cache:{missesNo:0,missesTotal:0,hitsNo:0,hitsTotal:0}}},t.exports=c},function(t,e,n){"use strict";(function(e){var n=Symbol.for("TinyCache.data");Object.getOwnPropertySymbols(e).indexOf(n)>-1||(e[n]={});var i={get:function(t){return new Promise(function(i){i(e[n][t])})},set:function(t,i){return new Promise(function(r){e[n][t]=i,r(!0)})}};Object.freeze(i),t.exports=i}).call(e,n(2))},function(t,e){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(n=window)}t.exports=n}])});