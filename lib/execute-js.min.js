!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("execute-js",[],e):"object"==typeof exports?exports["execute-js"]=e():t["execute-js"]=e()}(this,function(){return function(t){function e(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var n={};return e.m=t,e.c=n,e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=0)}([function(t,e,n){"use strict";function r(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},s=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),c=function(){function t(e){o(this,t);var r={logger:console,cache:n(1)};this._actions={default:t.defaultAction.bind(this),map:t.mapActionHandler.bind(this)},this._options=t.spreadify()(r,e||{})}return s(t,null,[{key:"getByPath",value:function(t,e){if(0===e.length)return t;for(var n=e.split("."),r=0;r<n.length;r++)t=t[n[r]];return t}},{key:"addPrefixToPath",value:function(t,e){for(var n={},r=n,o=t.split("."),i=0;i<o.length;i++)r[o[i]]={},i===o.length-1?r[o[i]]=e:r=r[o[i]];return n}},{key:"spreadify",value:function(e){return function(){for(var n=arguments,o={},s=!0,c=!0,u=0;u<arguments.length;u++)!function(u){var a=n[u];Array.isArray(a)&&s?c?(o=[].concat(r(a)),c=!1):o=o.concat(a):Object.keys(a).map(function(n){s=!1,e&&"object"===i(o[n])&&null!==o[n]&&null!==a[n]?o[n]=t.spreadify(e)(o[n],a[n]):o[n]=a[n]})}(u);return o}}},{key:"clone",value:function(e){var n=void 0;if("object"!==(void 0===e?"undefined":i(e))||null===e)return e;if(e instanceof Array){n=[];for(var r=0,o=e.length;r<o;r++)n[r]=t.clone(e[r]);return n}n={};for(var s in e)n[s]=t.clone(e[s]);return n}}]),s(t,[{key:"use",value:function(t){if(!t.type)throw new Error("type is missing in middleware contract");switch(t.type){case"action":return this.addActionMiddleware(t);default:throw new Error("Unknown middleware type")}}},{key:"addActionMiddleware",value:function(t){if(!t.action)throw new Error("middleware action is missing");if(!t.name)throw new Error("middleware name is missing");return this._actions[t.name]=t.action,!0}},{key:"run",value:function(t,e){return this.processSteps(t,e).then(function(t){return t.result})}},{key:"goToNextStep",value:function(t,e){var n="function"==typeof t.test?t.test(e):t.test;this._options.logger.info("Test result: "+n);var r=void 0!==t.if[n]?t.if[n]:t.if.default;return"number"==typeof r?Promise.resolve({result:{},signal:r}):r?this.processSteps(r,e):Promise.reject("Unhandled scenario")}},{key:"executeStepActionWithRetry",value:function(t,e){var n=this;return function r(o){var i=n._actions[t.actionType](t.action,e,n._options);return Promise.resolve(i).catch(function(e){return t.statistics.errors++,--o>0&&t.errorHandling.tryCondition(e)?(n._options.logger.warn("Step: "+t.title+" failed. Retrying."),r(o)):(n._options.logger.error("Step: "+t.title+" action failed."),Promise.reject(e))})}(t.errorHandling.maxAttempts)}},{key:"executeStepActionWithCache",value:function(t,e){var n=this;if(t.cache.enable){var r=t.cache.key(e);return Promise.resolve(this._options.cache.has(r)).then(function(o){return console.log("Has Data:",o),o?(t.statistics.cache.hits++,Promise.resolve(n._options.cache.get(r))):(t.statistics.cache.misses++,n.executeStepActionWithRetry(t,e).then(function(e){return Promise.resolve(n._options.cache.set(r,e,t.cache.ttl)).then(function(t){return console.log("Set Data in Cache result:",t),Promise.resolve(e)})}))})}return this.executeStepActionWithRetry(t,e)}},{key:"executeStepActionAndHandleError",value:function(t,e){var n=this;return this.executeStepActionWithCache(t,e).catch(function(r){return Promise.resolve(t.errorHandling.onError(r,e,n._options)).then(function(e){return t.errorHandling.continueOnError?e:Promise.reject(r)})})}},{key:"processStep",value:function(e,n){var r=this;return this._options.logger.info("Step: "+e.title),new Promise(function(o,i){"test"in e?r.goToNextStep(e,n).then(function(n){r._options.logger.info("Child result: "+JSON.stringify(n.result)),n.result=t.getByPath(n.result,e.output.map.source),r._options.logger.info("Total result: "+JSON.stringify(n.result)),o(n)}).catch(function(t){i(t)}):r.executeStepActionAndHandleError(e,n).then(function(n){var i=t.getByPath(n,e.output.map.source);r._options.logger.info("Action result: "+JSON.stringify(i)),o({result:i,signal:t.executionMode.CONTINUE})}).catch(function(t){i(t)})})}},{key:"recordStatistics",value:function(t,e){t.statistics.count++,t.statistics.min=Math.min(e,t.statistics.min),t.statistics.max=Math.max(e,t.statistics.max),t.statistics.total+=e,t.statistics.avg=t.statistics.total/t.statistics.count}},{key:"processSteps",value:function(e,n){function r(){if(c<a.length&&s===t.executionMode.CONTINUE)return a[c++]().then(r)}var o=this,i={},s=t.executionMode.CONTINUE,c=0,u=[],a=[];for(e.steps.map(function(e){a.push(function(){var r=new Date;return o.processStep(e,n).then(function(c){var u=new Date-r;o.recordStatistics(e,u),s=Math.max(s,c.signal),e.output.accessibleToNextSteps&&(n=0!==e.output.map.destination.length?t.spreadify()(n,t.addPrefixToPath(e.output.map.destination,c.result)):t.spreadify()(n,c.result));var a={};return e.output.addToResult&&(a=0!==e.output.map.destination.length?t.addPrefixToPath(e.output.map.destination,c.result):c.result),i=t.spreadify(!0)(i,a),{result:i,signal:s}})})});c<e.concurrency&&c<a.length;)u.push(r());return Promise.all(u).then(function(){return{result:i,signal:s===t.executionMode.STOP_ENTIRE_EXECUTION?i:t.executionMode.CONTINUE}})}}],[{key:"defaultAction",value:function(t,e,n){return Promise.resolve(t(e,n))}},{key:"mapActionHandler",value:function(t,e,n){var r=[];return t.array(e).reduce(function(e,o){return e.then(function(){return Promise.resolve(t.reducer(o,n)).then(function(t){return r.push(t),r})}).catch(console.error)},Promise.resolve())}},{key:"prepareExecutionTree",value:function(e){var n=void 0;return n="[object Array]"===Object.prototype.toString.call(e)?{steps:e}:e,n=t.spreadify(!0)(t.executionTreeDefaultSetting,n),n.steps.forEach(function(e,r){n.steps[r]=t.prepareExecutionTreeStep(e)}),n}},{key:"prepareExecutionTreeStep",value:function(e){var n=this,r=t.spreadify(!0)(t.clone(t.stepDefaultSetting),e);return void 0!==r.if&&Object.keys(r.if).forEach(function(t){"object"===i(r.if[t])&&(r.if[t]=n.prepareExecutionTree(r.if[t]))}),r}},{key:"extractStatistics",value:function(e){var n={steps:[]};return e.steps.forEach(function(e,r){n.steps.push({});var o=n.steps[r];o.title=e.title,o.statistics=e.statistics,void 0!==e.if&&(o.if={},Object.keys(e.if).forEach(function(n){"object"===i(e.if[n])&&(o.if[n]=t.extractStatistics(e.if[n]))}))}),t.clone(n)}}]),t}();c.executionMode={CONTINUE:0,STOP_LEVEL_EXECUTION:1,STOP_ENTIRE_EXECUTION:2},c.executionTreeDefaultSetting={concurrency:1},c.stepDefaultSetting={title:"No name step",errorHandling:{maxAttempts:0,tryCondition:function(){return!0},continueOnError:!1,onError:function(){return{}}},cache:{enable:!1,ttl:60},output:{accessibleToNextSteps:!0,addToResult:!0,map:{source:"",destination:""}},actionType:"default",action:function(){return{}},statistics:{count:0,total:0,min:Number.MAX_VALUE,max:0,avg:null,errors:0,cache:{misses:0,hits:0}}},t.exports=c},function(t,e,n){"use strict";(function(e){var n=Symbol.for("TinyCache.data");Object.getOwnPropertySymbols(e).indexOf(n)>-1||(e[n]={});var r={get:function(t){return e[n][t]},has:function(t){return!!e[n][t]},set:function(t,r){return e[n][t]=r,!0}};Object.freeze(r),t.exports=r}).call(e,n(2))},function(t,e){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(n=window)}t.exports=n}])});